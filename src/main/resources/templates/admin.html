<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script th:src="@{/webjars/jquery/3.1.1/jquery.min.js}"></script>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/3.3.5/css/bootstrap.css}">
    <script th:src="@{/webjars/layui/src/layui.js}"></script>
    <link rel="stylesheet" th:href="@{/webjars/layui/src/css/layui.css}">
    <script type="text/javascript" th:src="@{/webjars/bootstrap/3.3.5/js/bootstrap.js}"></script>
    <script th:src="@{/webjars/sockjs-client/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/stomp.min.js}"></script>
</head>
<body>
<table>
        <tr>
            <td th:text="${session.user.getUserId()}"></td>
            <td th:text="${session.user.getUserType()}" ></td>
            <td><a th:href="${#httpServletRequest.getContextPath()+'/vote/list'}" th:if="${session.user.userType==1}" th:text="投票管理"  >投票管理</a></td>
            <td th:text="${session.user.getUserAdim()}"></td>
            <td th:text="${session.user.getUserName()}"></td>
            <td th:text="${session.user.getUserRegistration()}"></td>
            <td th:text="${session.user.getUserMoney()}"></td>
            <td th:text="${session.user.getUserVipWhether()}"></td>
        </tr>
        <tr>
            <td><a th:href="${#httpServletRequest.getContextPath()+'/activity/huo'}" th:if="${session.user.userType==1}" th:text="发起活动" >发起活动</a></td>
        </tr>
        <tr>
            <td><a th:href="${#httpServletRequest.getContextPath()+'/activity/delhuo'}" th:if="${session.user.userType==1}" th:text="活动管理" >活动管理</a></td>
        </tr>
    <!-- 资金流动  -->
    <tr th:each="shu:${shu}">
        <td><a th:href="${#httpServletRequest.getContextPath()+'/user-message/sel/?userIde='+shu.userMessage.getUserId()}">修改</a></td>
        <td th:text="${shu.userMessage.getUserId()}"></td>
        <td th:text="${shu.userMessage.getUserName()}"></td>
        <td th:text="${shu.userMessage.getUserMoney()}"></td>
        <td th:text="${shu.userRechargeMoney}"></td>
        <td th:text="${shu.userRechargeActualamount}"></td>
        <td><a th:href="${#httpServletRequest.getContextPath()+'/user-message/del/?userId='+shu.userMessage.getUserId()}">删除</a></td>
    </tr>
</table>
<table>
    <tr th:each="UserMessage : ${userList}">
        <td><span th:text="${UserMessage.getUserName()}" th:id="${UserMessage.getUserId()}"></span><input  type="button" value="关注" onclick="gz(this)"></input></td>
    </tr>
</table>
<table id="wdgz">
    <tr>
        <td>我的关注</td>
    </tr>
    <tr  th:each="concern :${concernList}">
        <td><span th:text="${concern.getConcernName()}" th:id="${concern.getConcernId()}"></span><input type="button" value="取消关注" onclick="qxgz(this)"></input></td>
    </tr>
</table>
<table>
    <tr>
        <td>我的粉丝</td>
    </tr>
    <tr th:each="fans :${fansList}">
        <td><span th:text="${fans.getFansName()}" th:id="${fans.getFansId()}"></span></td>
        <br>
    </tr>
</table>
<table>
    <tr>
        <!--<td>请输入用户名：</td>-->
        <td><input type="text" id="name" hidden="hidden" th:value="${session.user.getUserName()}" /></td>
    </tr>
    <tr>
        <td><input class="layui-icon-release" type="button" id="connect" value="发消息" /></td>
    </tr>
</table>
<div id="chat" style="display: none">
    <table>
        <tr>
            <td>请输入聊天内容：</td>
            <td><input type="text" id="content"/></td>
            <td><input type="button" id="send" value="发送" /></td>
            <td><input type="button" id="disconnect" disabled="disabled" value="断开连接" /></td>
        </tr>
    </table>
    <div id="conversation">群聊进行中...</div>
</div>

<script type="text/javascript">
    $(function () {
        $("#connect").click(function () {
            connect();
        })
        $("#disconnect").click(function () {
            if(stompClient != null){
                stompClient.disconnect();
            }
            setConnected(false);
        })
        $("#send").click(function () {
            stompClient.send('/app/hello',{},JSON.stringify({'name':$("#name").val(),'content':$("#content").val()}));
        })
    })
    var stompClient = null;
    function connect() {
        if(!$("#name").val()){
            return;
        }
        var socket = new SockJS('../chat'); <!-- 与socket建立连接 -->
        stompClient = Stomp.over(socket);
        stompClient.connect({},function success() {
            setConnected(true);
            stompClient.subscribe('/yad',function success(msg) {
                showGreeting(JSON.parse(msg.body));
            })
        })
    }
    function showGreeting(msg) {
        $("#conversation").append('<div>'+msg.name+':'+msg.content+'</div>');
    }
    function setConnected(flag) {
        $("#connect").prop("disabled",flag);
        $("#disconnect").prop("disabled",!flag);
        if(flag){
            $("#chat").show();
        }else{
            $("#chat").hide();
        }
    }


    function gz(t) {
        var name= $(t).prev().text();
        var id=$(t).prev().attr("id");
        $.get("../concern/add/","name="+name+"&id="+id,function (date) {
            if(date>0){
                $(t).val("已关注");
                $("#wdgz").append("<tr><td><span id='"+id+"'>"+name+"</span><input type=\"button\" value=\"取消关注\" onclick=\"qxgz(this)\"></input></td></tr>")
            }
        })
    }
    function qxgz(q) {
        var id=$(q).prev().attr("id");
        $.get("../concern/del/","id="+id,function (date){
            if(date>0){
                $(q).parent().parent().remove();
            }
        })
    }
</script>
</body>
</html>